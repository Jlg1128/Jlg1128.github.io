<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_io/favicon-16x16.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jlg1128.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":50,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="JLG&#39;s Blog">
<meta property="og:url" content="https://jlg1128.github.io/index.html">
<meta property="og:site_name" content="JLG&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jlg1128">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://jlg1128.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>JLG's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="JLG's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">JLG's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jlg1128"
      src="/images/avator-2.jpeg">
  <p class="site-author-name" itemprop="name">Jlg1128</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Jlg1128" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Jlg1128" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/jlg1128@163.com" title="E-Mail → jlg1128@163.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/10/28/Yalc-breaking-scss-file-caching/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/28/Yalc-breaking-scss-file-caching/" class="post-title-link" itemprop="url">Yalc使scss文件缓存失效问题排查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-10-28 08:25:00" itemprop="dateCreated datePublished" datetime="2025-10-28T08:25:00+08:00">2025-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-10-30 10:02:28" itemprop="dateModified" datetime="2025-10-30T10:02:28+08:00">2025-10-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Yalc是类似npm link&#x2F;yarn link本地开发库时快速调试的工具。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>本地开发二方包时用的Yalc调试，但是发现变更库代码所有scss文件都重新编译了，导致热更新耗时较长（12s左右），比较影响开发效率和体验。</p>
<h2 id="原因排查"><a href="#原因排查" class="headerlink" title="原因排查"></a>原因排查</h2><p>首先排除是yalc push导致库的所有文件时间戳变更</p>
<ol>
<li>因为只有scss文件重新编译，tsx文件并没有，按理来说都会重新编译</li>
<li>查阅yalc源码发现yalc push后从yalc store（yalc存放所有包的地方）复制到node_modules目录的过程会<a target="_blank" rel="noopener" href="https://github.com/wclr/yalc/blob/3b834e488837e87df47414fd9917c10f07f0df08/src/sync-dir.ts#L43">比较filehash</a>  <img src="/images/yalc-scss/yalc-copy.png" width="700" alt="yalc-copy"></li>
</ol>
<p>推测是<strong>fileSystem缓存失效</strong>导致，开始debug Webpack，从NormalModule’s needBuild开始（NormalModule是Webpack中的基础module类，负责解析、构建js等，js、css文件最后都是normalModule），发现Webpack会对module.buildInfo.snapshot做校验，buildInfo是module的一些构建信息，包含fileDependencies（文件依赖）、buildDependencies（构建依赖，比如loader）等，snapshot是文件的快照（包含了buildInfo信息，用来校验文件缓存），debug发现snapshot依赖了lib&#x2F;package.json，查看package.json，<strong>增加了yalcSig字段</strong>，猜测是lib&#x2F;package.json变更导致缓存失效。<br><img src="/images/yalc-scss/cache-check.png" width="700" alt="cache-check"><br><img src="/images/yalc-scss/cache-dep.png" width="700" alt="cache-dep"></p>
<p>修改yalc源码，阻止更改package.json，<strong>只有变更的scss文件重新编译</strong>，确定yalc修改二方包的package.json导致的。</p>
<h2 id="深入分析"><a href="#深入分析" class="headerlink" title="深入分析"></a>深入分析</h2><ol>
<li><p>为什么tsx文件缓存没有失效？<br> debug看到tsx module.buildInfo.snapshot上只有自己的路径，因为每个tsx文件都是一个module，module之间有依赖关系，而scss文件比如a.scss使用了”@import ‘~@xx.scss’”的语法，只有a.scss是一个module，@xx.scss并没有当作module，所以在文件系统层面需要记录文件之间的依赖。scss-loader用Webpack的enhanced-resolve解析@xx.scss得到的路径，都会加入到a.scss的snapshot。最终fileDependencies作为snapshot的一部分存入缓存，以便下次needBuild时判断缓存是否失效。</p>
 <img src="/images/yalc-scss/module-needbuild.png" width="700" alt="module-needbuild">
</li>
<li><p>缓存失效与snapshot.managedPaths配置有关<br> snapshot.managedPaths表示Webpack缓存只检测package.json(name+version)是否有变更，它的默认配置是[&#x2F;^(.+?[\&#x2F;]node_modules[\&#x2F;])&#x2F;]表示node_modules中的缓存是否失效只与包名和版本号有关。Yalc默认不会变更package.json的version和name导致想要代码变更生效必须要在managedPaths中排除二方包的目录，排除了之后Webpack不仅仅会校验版本号和包名，还未校验时间戳和hash。导致scss缓存实效。</p>
</li>
</ol>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol>
<li>（目前方案）因为yalc最近两年不活跃，提issue增加不改package.json的配置没反馈，所以通过fork yalc包，删除改package.json的逻辑（该逻辑无作用，本地无需yalcSig签名也可触发重新编译），这段改动较小，且开发侧无需任何配置，只需要重新安装yalc即可.</li>
<li>配置Webpack snapshot，忽略校验package.json的文件时间戳和hash，但是会导致node_modules依赖的变更无法弃用缓存等问题<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;</span><br><span class="line">  ...,</span><br><span class="line">  <span class="attr">snapshot</span>: &#123;</span><br><span class="line">    <span class="attr">immutablePaths</span>: [</span><br><span class="line">      <span class="regexp">/(.+?[\\/]node_modules[\\/]packageName[\\/]package\.json$)/</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="snapshot配置介绍（snapshot是Webpack文件系统缓存的配置，决定文件系统是如何创建和无效快照）"><a href="#snapshot配置介绍（snapshot是Webpack文件系统缓存的配置，决定文件系统是如何创建和无效快照）" class="headerlink" title="snapshot配置介绍（snapshot是Webpack文件系统缓存的配置，决定文件系统是如何创建和无效快照）"></a>snapshot配置介绍（snapshot是Webpack文件系统缓存的配置，决定文件系统是如何创建和无效快照）</h2><ol>
<li><p>buildDependencies<br>  构建缓存，主要是解析module的loader以及cache.buildDependencies</p>
</li>
<li><p>immutablePaths<br>  不可变的文件和目录，Webpack缓存不会去校验hash和timestamp</p>
</li>
<li><p>managedPaths<br>  一般是node_modules依赖，Webpack缓存会校验package.json的name和version</p>
</li>
<li><p>module<br>  module级别的缓存校验</p>
</li>
<li><p>resolve<br>  解析import时，会先走resolveCache的判断，缓存有效就不会走module.build</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/08/20/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/20/undefined/" class="post-title-link" itemprop="url">手撕源码: mobx</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-08-20 10:00:07 / Modified: 10:08:16" itemprop="dateCreated datePublished" datetime="2025-08-20T10:00:07+08:00">2025-08-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><p>初始化</p>
</li>
<li><p>get<br>bindDependencies</p>
</li>
</ol>
<p>reaction.observing_ &#x3D; reaction.newObserving_;<br>将reaction添加到observable（addObserver(dep, derivation)）<br>reaction.runReaction_ -&gt; reaction.onInvalidate_ -&gt; 重新运行view </p>
<ol start="3">
<li><p>set<br>set后propagateChanged，将observable的</p>
</li>
<li><p>computed</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/08/12/cognition-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/12/cognition-reading-notes/" class="post-title-link" itemprop="url">看完了《认知觉醒：开启自我改变的原动力》，我觉得无所不能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-12 10:08:38" itemprop="dateCreated datePublished" datetime="2025-08-12T10:08:38+08:00">2025-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-10-28 08:48:53" itemprop="dateModified" datetime="2025-10-28T08:48:53+08:00">2025-10-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近看完了《认知觉醒：开启自我改变的原动力》，写个读后感，算是对这本书部分内容的实践，也就是读是最浅层的，一些道理必须要思考和实践才能变成自己的。</p>
<p>这本书从人的大脑由本能脑、情绪脑、理智脑组成到分析人的行为与这些组成部分的关系，最后分析如何运用让自己变得更加优秀，讲了非常多以前不知道的东西，看下来非常有收获，印象最深的是以下三个点。</p>
<h3 id="急于求成是人的本能"><a href="#急于求成是人的本能" class="headerlink" title="急于求成是人的本能"></a>急于求成是人的本能</h3><p>急于求成是我比较大的问题，事情都在追求快，觉得时间很宝贵，必须要在xx小时内完成，否则就是浪费时间，所以在遇到特别困难的点时总想着没时间了模棱两可的处理一下，最后做出来的东西其实自己也不是特别满意。</p>
<p>这本书里讲耐心是制胜的法宝，我非常认可，有时候慢就是快，慢下来多去思考，遇到困难就去把困难拆解，单独去解决，所有都解决了再在之前的基础上去做迭代优化，最后的成功想做的不好都难。</p>
<p>越能克服天性，耐心水平越高，越能成功。</p>
<h3 id="构建清晰的目标"><a href="#构建清晰的目标" class="headerlink" title="构建清晰的目标"></a>构建清晰的目标</h3><p>有时候行动力不强，是自己的目标不够明确清晰，想想也是，在早上拖延刷手机不起来学习最根本的原因我觉得一是要做的事情有很多，大脑很模糊，二是对自身的未来方向不够明确，信念不够强，比如我想做前端架构师，就得去拼命钻研开源项目源码、了解他们的思想，我不想成为平庸的人。有了信念加上清晰的目标，行动力会非常强大。</p>
<p>所以我每天晚上都会给第二天早上上班前的空闲时间定一个明确的目标，写具体事情的blog、手撕具体开源项目的源码，事情都确定下来。</p>
<h3 id="刻意练习"><a href="#刻意练习" class="headerlink" title="刻意练习"></a>刻意练习</h3><p>一些道理和知识点在忽然get到的时候会非常开心，但其实这个时候不应该那么开心，因为这些东西还没有成为自己的。<br>在我们阅读鸡汤、技术博客&#x2F;视频甚至学英语时了解到的内容必须要在日常中多实践，get到 -&gt; 输出&#x2F;思考 -&gt; 反复实践才能成为自己的。</p>
<p>练习也是有技巧的，应当在舒适区边缘，内容既不要太难也不要太容易，假如太困难，可以拆解成一个个小问题逐一解决，也相当于在舒适区边缘。  </p>
<div style="text-align: center;">
<img src="/images/aweakup/image.png" width="700" alt="studymethod">
</div>

<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p>急于求成为什么是本能，主要是多巴胺驱动我们要快速得到反馈，一旦反馈减少，多巴胺下降，就感觉不那么爽了。其实多巴胺好的一面是它会促成你尽快完成当前的目标，质量虽然没那么好，起码是完成了，但是对于我这样的程序员来说，有些复杂的东西比如性能优化、框架底层原理等等不掌握到90分深度还是不够，需要有面对长时间没有及时反馈的勇气，还需要信念、自我要求去驱动达成。</p>
<p>文章里的还有个点我觉得也蛮重要的，一篇或者或者一本书又或者工作了一天，其实只要有一两个重点能去把握住，深入思考、反复练习就够了，太多太杂最后反而什么事都做的不好，还是要专注。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/08/07/react-context-principles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/07/react-context-principles/" class="post-title-link" itemprop="url">React Context 原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-07 09:11:44" itemprop="dateCreated datePublished" datetime="2025-08-07T09:11:44+08:00">2025-08-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 10:08:50" itemprop="dateModified" datetime="2025-08-19T10:08:50+08:00">2025-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近在调研状态管理库，顺便研究了下Context(React 18.1)的原理，</p>
<p>以下解析基于该<a target="_blank" rel="noopener" href="https://codesandbox.io/p/sandbox/react-context-provider-example-hooks-forked-jhkplf">case</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dataContext = <span class="title function_">createContext</span>();</span><br><span class="line"><span class="keyword">const</span> themeContext = <span class="title function_">createContext</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Provider</span> = (<span class="params">&#123; children &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(<span class="string">&quot;This is the data!&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> dataContextValue = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [data, setData];</span><br><span class="line">  &#125;, [data, setData]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">themeContext.Provider</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">dataContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;dataContextValue&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">dataContext.Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">themeContext.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Consumer</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useContext</span>(dataContext);</span><br><span class="line">  <span class="keyword">const</span> theme = <span class="title function_">useContext</span>(themeContext);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>current theme is &#123;theme&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setData(Date.now())&#125;&gt;Click to change data!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;data&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Consumer</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="context在fiber上的结构"><a href="#context在fiber上的结构" class="headerlink" title="context在fiber上的结构"></a>context在fiber上的结构</h2><p>case中的Consumer组件使用了两个Context，context的存储也和别的hooks一样，是链表结构存储在fiber.dependency上。<br><img src="/images/React-Context/context-chain.png" width="700" alt="context-chain"></p>
<h2 id="在Context-value更新之后，是如何通知订阅该Context的组件更新的"><a href="#在Context-value更新之后，是如何通知订阅该Context的组件更新的" class="headerlink" title="在Context value更新之后，是如何通知订阅该Context的组件更新的"></a>在Context value更新之后，是如何通知订阅该Context的组件更新的</h2><p>context value的更新一般是通过Provider所在组件通过setState触发，setState后整个React树从上而下进行reconciliation，在update Provider组件时发现value变更了，然后通知订阅方进行更新。<br><img src="/images/React-Context/provider-reconcilation.png" width="700" alt="provider-reconcilation"></p>
<p><strong>如何通知相关联的组件</strong><br>dfs遍历fiber tree，判断每个组件上的dependency链表包含了当前变更的context，发现有变更，将该fiber的lane与当前的更新优先级renderLane合并，后续在reconcile该组件时就会判断fiber上是否包含renderLane来决定该fiber是否需要更新<br><img src="/images/React-Context/context-change-notify.png" width="700" alt="context-change-notify"></p>
<p>判断是否有update<br><img src="/images/React-Context/update-component.png" width="700" alt="update-component"></p>
<h2 id="多个相同-Provider-可以嵌套使用，里层的会覆盖外层的数据的实现原理"><a href="#多个相同-Provider-可以嵌套使用，里层的会覆盖外层的数据的实现原理" class="headerlink" title="多个相同 Provider 可以嵌套使用，里层的会覆盖外层的数据的实现原理"></a>多个相同 Provider 可以嵌套使用，里层的会覆盖外层的数据的实现原理</h2><p>React通过堆栈来实现，在reconcile Provider时会将最新的value赋值到context上，将旧值存储到站栈里，在完成对Provider的reconcilation(completeWork)后，将旧值pop出来作为context.value。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">pushProvider</span>(<span class="params">providerFiber, context, nextValue</span>) &#123;</span><br><span class="line">  <span class="title function_">push</span>(valueCursor, context.<span class="property">_currentValue</span>, providerFiber);</span><br><span class="line">  context.<span class="property">_currentValue</span> = nextValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">popProvider</span>(<span class="params">context, providerFiber</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> currentValue = valueCursor.<span class="property">current</span>;</span><br><span class="line">  <span class="title function_">pop</span>(valueCursor, providerFiber);</span><br><span class="line">  <span class="keyword">if</span> ( currentValue === <span class="variable constant_">REACT_SERVER_CONTEXT_DEFAULT_VALUE_NOT_LOADED</span>) &#123;</span><br><span class="line">    context.<span class="property">_currentValue</span> = context.<span class="property">_defaultValue</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    context.<span class="property">_currentValue</span> = currentValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="全局状态的合理使用"><a href="#全局状态的合理使用" class="headerlink" title="全局状态的合理使用"></a>全局状态的合理使用</h2><p>因为context value的变更会遍历所有的fiber，如果页面很复杂，组件层级很深数量庞大，开销也是很大的。</p>
<p>所以在给Provider设置value时应该用useMemo(value)以及减少value的变化。</p>
<h2 id="React-Redux-是如何设计-Provider-的？"><a href="#React-Redux-是如何设计-Provider-的？" class="headerlink" title="React Redux 是如何设计 Provider 的？"></a>React Redux 是如何设计 Provider 的？</h2><p>React Redux 的 Provider 接收 store，而 store 在创建初期就保持不变，因此 Provider 的 store 在整个应用生命周期内都不会发生改变，也就不会触发订阅的组件重新渲染。</p>
<p>我们通过 dispatch 触发的状态变更，实际上改变的是 store.state，然后通过 useSelector 或者 connect 订阅。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/07/29/zustand-principles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/29/zustand-principles/" class="post-title-link" itemprop="url">Zustand底层原理解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-29 10:11:57" itemprop="dateCreated datePublished" datetime="2025-07-29T10:11:57+08:00">2025-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 10:11:06" itemprop="dateModified" datetime="2025-08-19T10:11:06+08:00">2025-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Zustand是最近比较火的状态管理库，是Redux的替代品，相比于Redux，它的api简单，样板代码少，包体积小只有1.2KB（minified），基于hooks来管理状态以及生态也比较丰富，有immer、persist、redux等中间件。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>src&#x2F;vanilla.ts中的代码如下，vanilla的意思是这里导出的createStore各框架都能用，而非仅限于React。<br>源码比较简单，核心是基于发布订阅模式和useSyncExternalStore实现的。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/vanilla.ts</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">createStoreImpl</span>: <span class="title class_">CreateStoreImpl</span> = <span class="function">(<span class="params">createState</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">type</span> <span class="title class_">TState</span> = <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> createState&gt;</span><br><span class="line">  <span class="keyword">type</span> <span class="title class_">Listener</span> = <span class="function">(<span class="params"><span class="attr">state</span>: <span class="title class_">TState</span>, <span class="attr">prevState</span>: <span class="title class_">TState</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">state</span>: <span class="title class_">TState</span></span><br><span class="line">  <span class="comment">// 订阅者，包含了每个组件通过useSyncExternalStore绑定的重新渲染的方法</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">listeners</span>: <span class="title class_">Set</span>&lt;<span class="title class_">Listener</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 变更状态，可以只变更部分state，会做合并</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">setState</span>: <span class="title class_">StoreApi</span>&lt;<span class="title class_">TState</span>&gt;[<span class="string">&#x27;setState&#x27;</span>] = <span class="function">(<span class="params">partial, replace</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> nextState =</span><br><span class="line">      <span class="keyword">typeof</span> partial === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        ? (partial <span class="title function_">as</span> (<span class="attr">state</span>: <span class="title class_">TState</span>) =&gt; <span class="title class_">TState</span>)(state)</span><br><span class="line">        : partial</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Object</span>.<span class="title function_">is</span>(nextState, state)) &#123;</span><br><span class="line">      <span class="keyword">const</span> previousState = state</span><br><span class="line">      state =</span><br><span class="line">        (replace ?? (<span class="keyword">typeof</span> nextState !== <span class="string">&#x27;object&#x27;</span> || nextState === <span class="literal">null</span>))</span><br><span class="line">          ? (nextState <span class="keyword">as</span> <span class="title class_">TState</span>)</span><br><span class="line">          <span class="comment">// 更新state时用的是Object.assign，更改了state的引用，所以在使用state时，需要用selector或者useShallow。</span></span><br><span class="line">          : <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, state, nextState)</span><br><span class="line">      <span class="comment">// setState时触发更新</span></span><br><span class="line">      listeners.<span class="title function_">forEach</span>(<span class="function">(<span class="params">listener</span>) =&gt;</span> <span class="title function_">listener</span>(state, previousState))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getState方法实则是返回当前Store里的最新数据</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">getState</span>: <span class="title class_">StoreApi</span>&lt;<span class="title class_">TState</span>&gt;[<span class="string">&#x27;getState&#x27;</span>] = <span class="function">() =&gt;</span> state</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">getInitialState</span>: <span class="title class_">StoreApi</span>&lt;<span class="title class_">TState</span>&gt;[<span class="string">&#x27;getInitialState&#x27;</span>] = <span class="function">() =&gt;</span></span><br><span class="line">    initialState</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">subscribe</span>: <span class="title class_">StoreApi</span>&lt;<span class="title class_">TState</span>&gt;[<span class="string">&#x27;subscribe&#x27;</span>] = <span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</span><br><span class="line">    listeners.<span class="title function_">add</span>(listener)</span><br><span class="line">    <span class="comment">// Unsubscribe</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> listeners.<span class="title function_">delete</span>(listener)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> api = &#123; setState, getState, getInitialState, subscribe &#125;</span><br><span class="line">  <span class="keyword">const</span> initialState = (state = <span class="title function_">createState</span>(setState, getState, api))</span><br><span class="line">  <span class="keyword">return</span> api <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createStore = (<span class="function">(<span class="params">createState</span>) =&gt;</span></span><br><span class="line">  createState ? <span class="title function_">createStoreImpl</span>(createState) : createStoreImpl) <span class="keyword">as</span> <span class="title class_">CreateStore</span></span><br></pre></td></tr></table></figure>

<p>在React中集成</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/react.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> useStore&lt;<span class="title class_">TState</span>, <span class="title class_">StateSlice</span>&gt;(</span><br><span class="line">  <span class="attr">api</span>: <span class="title class_">ReadonlyStoreApi</span>&lt;<span class="title class_">TState</span>&gt;,</span><br><span class="line">  <span class="attr">selector</span>: <span class="function">(<span class="params"><span class="attr">state</span>: <span class="title class_">TState</span></span>) =&gt;</span> <span class="title class_">StateSlice</span> = identity <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 挂载组件更新的方法</span></span><br><span class="line">  <span class="keyword">const</span> slice = <span class="title class_">React</span>.<span class="title function_">useSyncExternalStore</span>(</span><br><span class="line">    api.<span class="property">subscribe</span>,</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">selector</span>(api.<span class="title function_">getState</span>()),</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">selector</span>(api.<span class="title function_">getInitialState</span>()), <span class="comment">// getServerSnapshot</span></span><br><span class="line">  )</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useDebugValue</span>(slice)</span><br><span class="line">  <span class="keyword">return</span> slice</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createImpl = &lt;T&gt;<span class="function">(<span class="params"><span class="attr">createState</span>: <span class="title class_">StateCreator</span>&lt;T, [], []&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> api = <span class="title function_">createStore</span>(createState)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">useBoundStore</span>: <span class="built_in">any</span> = <span class="function">(<span class="params">selector?: <span class="built_in">any</span></span>) =&gt;</span> <span class="title function_">useStore</span>(api, selector)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在store上挂载setState, getState, getInitialState, subscribe 这些方法</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">assign</span>(useBoundStore, api)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> useBoundStore</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> create = (&lt;T&gt;<span class="function">(<span class="params"><span class="attr">createState</span>: <span class="title class_">StateCreator</span>&lt;T, [], []&gt; | <span class="literal">undefined</span></span>) =&gt;</span></span><br><span class="line">  createState ? <span class="title function_">createImpl</span>(createState) : createImpl) <span class="keyword">as</span> <span class="title class_">Create</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Zustand是对useSyncExternalStore进行了封装，将状态统一管理在组件外部，避免了层层传递 Props。这种方式使得状态管理更加灵活，开发过程更加高效。</p>
<h2 id="与Redux的对比"><a href="#与Redux的对比" class="headerlink" title="与Redux的对比"></a>与Redux的对比</h2><ol>
<li>Zustand相对于Redux需要较少的代码，并且上手成本低</li>
<li>定义衍生状态，Redux通过自定义hook&#x2F;或者mapStateToProps实现，Zustand可以定义computed属性，相对来说比较方便。</li>
<li>Redux是单一store，Zustand可以是多Store</li>
</ol>
<h2 id="与MobX的对比"><a href="#与MobX的对比" class="headerlink" title="与MobX的对比"></a>与MobX的对比</h2><ol>
<li>没有computed缓存</li>
<li>更新粒度没有MobX细，开发时需要考虑如何避免重复渲染。</li>
<li>代码相对于MobX Store来说不够直观</li>
<li>体积小，Zustand + immer之后是14KB，mobx + mobx-react + mobx-react-lite是35KB</li>
<li>设置新状态需要用set(state &#x3D;&gt; newState)的方式，没有MobX来的直接并且符合直觉。</li>
<li>避免re-render不需要selector，心智负担更小，代码量更少。</li>
</ol>
<p>如果不考虑体积，我觉得可以直接选MobX。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/07/12/ai-datacenter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/ai-datacenter/" class="post-title-link" itemprop="url">AI数据中心笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-12 10:06:19" itemprop="dateCreated datePublished" datetime="2025-07-12T10:06:19+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 10:06:02" itemprop="dateModified" datetime="2025-08-19T10:06:02+08:00">2025-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这几年AI发展迅速，算力需求爆炸式增长，能源是AI发展的瓶颈之一。</p>
<h2 id="全球能源"><a href="#全球能源" class="headerlink" title="全球能源"></a>全球能源</h2><h3 id="发电结构"><a href="#发电结构" class="headerlink" title="发电结构"></a>发电结构</h3><p>中国：煤炭58.2%，天然气3.0%、太阳能8.3%、风电9.8%、水电13.5%、核能4.4%.<br>美国：天然气 43%、核能 19%、煤炭 16%、风能 10%、水力发电 6% 和太阳能 4%。<br>全球：煤炭约占30%，是最大的电力来源，但各地区差异很大，其中中国的贡献最大。可再生能源（主要是风能、太阳能光伏和水力发电）目前供应着全球数据中心约27%的电力。天然气是当今第三大电力来源，满足了26%的需求，其次是核能，占15%。</p>
<p>未来：可再生能源仍然是数据中心增长最快的电力来源。未来五年，可再生能源将满足近一半的新增需求，其次是天然气和煤炭，而核能将在本十年末及以后开始发挥日益重要的作用。</p>
<div style="text-align: center;">全球电力生成</div>
<img src="/images/ai-datacenter/electric-generation.png" width="700" alt="electric-generation">

<div style="text-align: center;">全球电力使用情况</div>
<img src="/images/ai-datacenter/power-usage.png" width="700" alt="power-usage">

<div style="text-align: center;">中国电力装机容量</div>
<img src="/images/ai-datacenter/china-power-generation-installed.png" width="700" alt="china-power-generation-installed">

<div style="text-align: center;">中国电力生成</div>
<img src="/images/ai-datacenter/china-electric-generation.png" width="700" alt="china-electric-generation">

<div style="text-align: center;">中国电力使用</div>
<img src="/images/ai-datacenter/china-power-usage.png" width="700" alt="china-power-usage">

<h2 id="数据中心简史"><a href="#数据中心简史" class="headerlink" title="数据中心简史"></a>数据中心简史</h2><p>20 世纪 90 年代，随着互联网的发展，我们需要处理日益增长的互联网数据，数据中心和云计算兴起。<br>2006年，随着亚马逊网络服务的发布，数据中心的低迷局面开始扭转。自那时起，美国数据中心的容量基本稳步增长。<br>2023 年，当时人工智能热潮席卷而来。 目前估计，到 2030 年，数据中心容量将翻一番。<br>AI 训练的独特工作负载促使人们重新关注数据中心的规模。计算基础设施越紧密，性能就越高。此外，当数据中心被设计为计算单元，而不仅仅是服务器机房时，企业可以获得额外的集成优势。<br>因为AI模型训练不需要靠近最终用户，因此训练相关的数据中心可以在任何地方建立。</p>
<h2 id="建数据中心需要什么"><a href="#建数据中心需要什么" class="headerlink" title="建数据中心需要什么"></a>建数据中心需要什么</h2><h3 id="设备"><a href="#设备" class="headerlink" title="设备"></a>设备</h3><ol>
<li><p>电气设备和冷却设备<br>电气设备首先由连接外部能源的主开关设备组成。然后，主开关设备连接到配电单元、不间断电源 (UPS) 以及连接服务器机架的线缆。大多数数据中心还会配备柴油发电机，作为停电时的备用电源。<br>冷却设备。这包括冷水机组、冷却塔、暖通空调设备以及连接到服务器本身的液体或空气冷却设备。</p>
</li>
<li><p>GPU和AI accelerator<br>AI训练、推理、计算</p>
</li>
<li><p>CPU<br>复杂运算和委派任务</p>
</li>
<li><p>数据存储</p>
</li>
</ol>
<h3 id="动力"><a href="#动力" class="headerlink" title="动力"></a>动力</h3><ol>
<li><p>能源<br>化石燃料、可再生能源、核能</p>
</li>
<li><p>输电<br>高压线路、变压器、变电站</p>
<img src="/images/ai-datacenter/power-tranport.png" width="700" alt="ai-datacenter-power-tranport"></li>
</ol>
<p>快速提升能源容量并不是简单的事，数据中心有两种选择，并网能源和离网能源。并网能源通过电网，由公用事业公司分配。离网能源则绕过电网，例如现场太阳能、风能和电池。并网能源面临的问题在于，扩大电网容量所需的时间平均为50个月（2023年）。因此，近期仍以化石燃料发电为主。</p>
<p>数据中心的耗电量，从 2001 年的几兆瓦 ，到 2010 年代的 50 兆瓦 ，再到 2020 年的“120 兆瓦”巨型数据中心 ，再到如今的千兆瓦级。所有科技公司都更倾向于使用并网电力，AWS 正在印第安纳州投资 110 亿美元建设一个数据中心园区 ，并建设四个太阳能发电场和一个风力发电场为其供电。<br>长效电池创新将是可再生能源向前迈出的重要一步。太阳能和风能的问题在于它们不稳定；它们只在有风或阳光充足时提供能源。长效电池有助于解决这个问题，它在能源过剩时储存能源，在能源短缺时释放能源。<br>储能有多种方式，国内外基本都是抽水储能为主，其余通过电池、热能存储、压缩空气和飞轮储能。</p>
<p>核能： 短期不太可能解决能源危机，耗时较久，国内5-10年，美国最近的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vogtle_Electric_Generating_Plant">核电站耗时 11 年，耗资超过 300 亿美元</a>建成。</p>
<h3 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h3><p>人工智能数据中心入门：<a target="_blank" rel="noopener" href="https://www.generativevalue.com/p/a-primer-on-ai-data-centers">https://www.generativevalue.com/p/a-primer-on-ai-data-centers</a><br>AI 数据中心（二）：能源 <a target="_blank" rel="noopener" href="https://www.generativevalue.com/p/ai-data-centers-part-2-energy">https://www.generativevalue.com/p/ai-data-centers-part-2-energy</a><br>2024年能源数据 <a target="_blank" rel="noopener" href="https://ember-energy.org/data/yearly-electricity-data/">https://ember-energy.org/data/yearly-electricity-data/</a><br>数据中心和能源 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=b6uCUuQwEog">https://www.youtube.com/watch?v=b6uCUuQwEog</a><br>美国发电结构 <a target="_blank" rel="noopener" href="https://www.eia.gov/tools/faqs/faq.php?id=427&t=3">https://www.eia.gov/tools/faqs/faq.php?id=427&amp;t=3</a><br>2024年中国年度电力市场报告 <a target="_blank" rel="noopener" href="https://www.nea.gov.cn/20250717/54ae0fdb11f04b39a5b670999c04ef81/2025071754ae0fdb11f04b39a5b670999c04ef81_19fe782a11f3aa40209907a80e3e692150.pdf">https://www.nea.gov.cn/20250717/54ae0fdb11f04b39a5b670999c04ef81/2025071754ae0fdb11f04b39a5b670999c04ef81_19fe782a11f3aa40209907a80e3e692150.pdf</a><br>iea2025年发布的能源与AI报告 <a target="_blank" rel="noopener" href="https://www.iea.org/reports/energy-and-ai">https://www.iea.org/reports/energy-and-ai</a><br>AI数据中心能源困境——AI数据中心空间的竞争 <a target="_blank" rel="noopener" href="https://semianalysis.com/2024/03/13/ai-datacenter-energy-dilemma-race/#ai-demand-vs-current-datacenter-capacity">https://semianalysis.com/2024/03/13/ai-datacenter-energy-dilemma-race/#ai-demand-vs-current-datacenter-capacity</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/06/26/playwright-mcp-compare-with-midcene/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/26/playwright-mcp-compare-with-midcene/" class="post-title-link" itemprop="url">Playwright MCP原理以及与Midscene.js的区别</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-26 10:04:27" itemprop="dateCreated datePublished" datetime="2025-06-26T10:04:27+08:00">2025-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 10:08:05" itemprop="dateModified" datetime="2025-08-19T10:08:05+08:00">2025-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Playwright-MCP原理"><a href="#Playwright-MCP原理" class="headerlink" title="Playwright-MCP原理"></a>Playwright-MCP原理</h2><p>Playwright有一个page._snapshotForAI方法，为html生成如下格式的字符串，基于html的aria也就是语义生成的，每个节点有个ref，ref是唯一的，元素的实现是通过这个ref来实现。</p>
<p>以下是通过page._snapshotForAI方法为 <a target="_blank" rel="noopener" href="https://playwright.dev/">https://playwright.dev/</a> 生成的部分字符串</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- generic [ref=e2]:</span><br><span class="line">  - region &quot;Skip to main content&quot;:</span><br><span class="line">    - link &quot;Skip to main content&quot; [ref=e4] [cursor=pointer]:</span><br><span class="line">      - /url: &quot;#__docusaurus_skipToContent_fallback&quot;</span><br><span class="line">  - navigation &quot;Main&quot; [ref=e5]:</span><br><span class="line">    - generic [ref=e6]:</span><br><span class="line">      - generic [ref=e7]:</span><br><span class="line">        - link &quot;Playwright logo Playwright&quot; [ref=e8] [cursor=pointer]:</span><br><span class="line">          - /url: /</span><br><span class="line">          - img &quot;Playwright logo&quot; [ref=e10] [cursor=pointer]</span><br><span class="line">          - generic [ref=e11] [cursor=pointer]: Playwright</span><br><span class="line">        - link &quot;Docs&quot; [ref=e12] [cursor=pointer]:</span><br><span class="line">          - /url: /docs/intro</span><br><span class="line">        - link &quot;API&quot; [ref=e13] [cursor=pointer]:</span><br><span class="line">          - /url: /docs/api/class-playwright</span><br><span class="line">        - button &quot;Node.js&quot; [ref=e15] [cursor=pointer]</span><br><span class="line">        - link &quot;Community&quot; [ref=e16] [cursor=pointer]:</span><br><span class="line">          - /url: /community/welcome</span><br></pre></td></tr></table></figure>

<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li>假如网站内容多，生成的snapshot就很大，与大模型交互的所需要的token就多，会存在费用高，token数限制的问题。</li>
<li>假如网站没做好aria无障碍，可能会存在识别精度低的问题。</li>
</ol>
<h2 id="与Midscene-js的区别"><a href="#与Midscene-js的区别" class="headerlink" title="与Midscene.js的区别"></a>与Midscene.js的区别</h2><ol>
<li><p>定位准确度<br>整体差不多，Playwright-MCP为每个节点生成ref，基于ref定位，而Midscene.js基于视觉大模型获取boundingBox，然后进行范围匹配，都是通过大模型语义识别。</p>
</li>
<li><p>可定位区域<br>Playwright-MCP支持整个网站，Midscene.js基于可视区域，假如有个按钮在弹窗下面，Midscene.js就无法识别了。</p>
</li>
<li><p>定位速度<br>Playwright-MCP较快，两个case 5s内完成了，但Midscene.js基于视觉大模型，速度较慢，本地试了下平均一个请求5-10s。</p>
</li>
<li><p>测试报告<br>Midscene.js有完善的用例报告回放，Playwright-MCP需要自己去接入或者实现一套。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/06/23/midscene-principles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/23/midscene-principles/" class="post-title-link" itemprop="url">Midscene.js原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-23 09:55:22" itemprop="dateCreated datePublished" datetime="2025-06-23T09:55:22+08:00">2025-06-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 12:16:08" itemprop="dateModified" datetime="2025-08-19T12:16:08+08:00">2025-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近浏览器agent例如Midscene.js、stagehand很火，好奇去体验了下然后了解了下原理。</p>
<h2 id="浏览器agent是什么"><a href="#浏览器agent是什么" class="headerlink" title="浏览器agent是什么"></a>浏览器agent是什么</h2><p>浏览器agent就是用户用自然语言跟浏览器对话，浏览器会自动执行一些操作、爬虫、断言，类似传动UI自动化、RPA解决重复劳动的问题。</p>
<h2 id="与传统UI自动化、RPA的区别"><a href="#与传统UI自动化、RPA的区别" class="headerlink" title="与传统UI自动化、RPA的区别"></a>与传统UI自动化、RPA的区别</h2><p>传统的UI自动化都是用硬编码获取元素，假如页面改动频繁，后续的维护成本非常高，但是浏览器agent能够适应经常变动的内容。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>假如我想要的人工地操作”在搜索框输入 “耳机” ，敲回车”，主要有以下几个步骤：</p>
<ol>
<li>定位搜索框</li>
<li>输入”耳机”</li>
<li>敲回车</li>
</ol>
<p>那么浏览器agent也一样需要执行这三个步骤</p>
<ol>
<li>根据网页显示，获取搜索框dom元素，并focus</li>
<li>执行输入”耳机”操作</li>
<li>按下 回车键</li>
</ol>
<p>Midscene.js是如何执行这三个操作的</p>
<h3 id="根据屏幕截图，获取搜索框DOM元素，并focus"><a href="#根据屏幕截图，获取搜索框DOM元素，并focus" class="headerlink" title="根据屏幕截图，获取搜索框DOM元素，并focus"></a>根据屏幕截图，获取搜索框DOM元素，并focus</h3><p>将screenshotBase64和prompt发送给视觉语言大模型，要求返回如下结构</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;what_the_user_wants_to_do_next_by_instruction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;在搜索框输入 &#x27;耳机&#x27; ，敲回车&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Now I want to use action &#x27;Input&#x27; to enter &#x27;耳机&#x27; in the search bar first.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;more_actions_needed_by_instruction&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="comment">// 是否还需要进行操作</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Input&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;locate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;bbox&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">269</span><span class="punctuation">,</span> <span class="number">57</span><span class="punctuation">,</span> <span class="number">824</span><span class="punctuation">,</span> <span class="number">87</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The search input field&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;param&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;耳机&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>根据bbox和DOM tree进行深度遍历 DOM节点范围匹配，得到范围最相近的DOM元素，当前是input元素，清空input中的内容。</p>
<h3 id="根据上一步的more-actions-needed-by-instruction判断是否还需要继续调用AI"><a href="#根据上一步的more-actions-needed-by-instruction判断是否还需要继续调用AI" class="headerlink" title="根据上一步的more_actions_needed_by_instruction判断是否还需要继续调用AI"></a>根据上一步的more_actions_needed_by_instruction判断是否还需要继续调用AI</h3><p>执行将上一步后将上一步的log和prompt发送给大模型，返回如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;what_the_user_wants_to_do_next_by_instruction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;在搜索框输入 \\&quot;</span>耳机\\<span class="string">&quot; 后，需要敲回车来执行搜索。&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="string">&quot;现在我将使用 &#x27;KeyboardPress&#x27; 动作来模拟敲击回车键以执行搜索。&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;more_actions_needed_by_instruction&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;KeyboardPress&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;param&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enter&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>执行KeyboardPress操作</p>
<h3 id="实现的伪代码"><a href="#实现的伪代码" class="headerlink" title="实现的伪代码"></a>实现的伪代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logList = [];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateTaskByUserPromptWithPageScreen</span>(<span class="params">prompt, &#123; logList &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;Planning&#x27;</span>,</span><br><span class="line">    <span class="attr">subType</span>: <span class="string">&#x27;Plan&#x27;</span>,</span><br><span class="line">    <span class="attr">locate</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">param</span>: &#123;</span><br><span class="line">      prompt,</span><br><span class="line">      <span class="attr">log</span>: logList,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">execute</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> screenShot = <span class="title function_">screenShot</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">callAiGetPlan</span>(prompt, &#123; <span class="attr">log</span>: logList.<span class="title function_">join</span>(<span class="string">&#x27;-&#x27;</span>), screenShot &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> planningTask = <span class="title function_">generateTaskByUserPromptWithPageScreen</span>(prompt);</span><br><span class="line"><span class="keyword">while</span> (planningTask) &#123;</span><br><span class="line">  <span class="keyword">const</span> planResult = planningTask.<span class="title function_">execute</span>();</span><br><span class="line">  <span class="keyword">const</span> &#123; log, more_actions_needed_by_instruction, actions &#125; = planResult;</span><br><span class="line">  <span class="keyword">const</span> newTasks = <span class="title function_">convertPlanToExecutable</span>(actions); <span class="comment">// &#x27;Tap&#x27; | &#x27;Hover&#x27; 等等</span></span><br><span class="line">  newTasks.<span class="title function_">execute</span>();</span><br><span class="line">  logList.<span class="title function_">push</span>(log);</span><br><span class="line">  <span class="keyword">if</span> (more_actions_needed_by_instruction) &#123;</span><br><span class="line">    planningTask = <span class="title function_">generateTaskByUserPromptWithPageScreen</span>(prompt, &#123;<span class="attr">log</span>: logList.<span class="title function_">join</span>(<span class="string">&#x27;-&#x27;</span>)&#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Midscene-js的缺点是什么"><a href="#Midscene-js的缺点是什么" class="headerlink" title="Midscene.js的缺点是什么"></a>Midscene.js的缺点是什么</h2><ol>
<li>成本<br>豆包和千问VL的计费都是输入：3元&#x2F;百万token，输出：9元&#x2F;百万token，像我们上述的调用输入是2400token，输出是100token，<br>上述的一个问题调用了两次AI，大概3元可以问150个问题，我觉得还能接受。</li>
<li>准确程度<br>Midscene.js是视觉分析得到元素的bounding box来获取元素的，可能会不准</li>
<li>运行速度<br>上述问题在本地调用两次”qwen-vl-max-latest”模型AI花用了15-20秒，时间稍长，但是一般都是异步任务也能接受。</li>
<li>一些操作没法实现<br>目前还不支持拖拽、双击、文件上传等等。</li>
<li>假如目标元素不在首屏，就无法定位元素。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>后续将会对比下和Playwright MCP的区别。</p>
<h2 id="附上plan的prompt"><a href="#附上plan的prompt" class="headerlink" title="附上plan的prompt"></a>附上plan的prompt</h2><h3 id="System-Prompt"><a href="#System-Prompt" class="headerlink" title="System Prompt"></a>System Prompt</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#x27;Target: User will give you a screenshot, an instruction and some previous logs indicating what have been done. Please tell what the next one action is (or null if no action should be done) to do the tasks the instruction requires. </span><br><span class="line"></span><br><span class="line">Restriction:</span><br><span class="line">- Don\&#x27;t give extra actions or plans beyond the instruction. ONLY plan for what the instruction requires. For example, don\&#x27;t try to submit the form if the instruction is only to fill something.</span><br><span class="line">- Always give ONLY ONE action in `log` field (or null if no action should be done), instead of multiple actions. Supported actions are Tap, Hover, Input, KeyboardPress, Scroll.</span><br><span class="line">- Don\&#x27;t repeat actions in the previous logs.</span><br><span class="line">- Bbox is the bounding box of the element to be located. It\&#x27;s an array of 4 numbers, representing 2d bounding box as [xmin, ymin, xmax, ymax].</span><br><span class="line"></span><br><span class="line">Supporting actions:</span><br><span class="line">- Tap: &#123; type: &quot;Tap&quot;, locate: &#123;bbox: [number, number, number, number], prompt: string &#125; &#125;</span><br><span class="line">- RightClick: &#123; type: &quot;RightClick&quot;, locate: &#123;bbox: [number, number, number, number], prompt: string &#125; &#125;</span><br><span class="line">- Hover: &#123; type: &quot;Hover&quot;, locate: &#123;bbox: [number, number, number, number], prompt: string &#125; &#125;</span><br><span class="line">- Input: &#123; type: &quot;Input&quot;, locate: &#123;bbox: [number, number, number, number], prompt: string &#125;, param: &#123; value: string &#125; &#125; // Replace the input field with a new value. `value` is the final that should be filled in the input box. No matter what modifications are required, just provide the final value to replace the existing input value. Giving a blank string means clear the input field.</span><br><span class="line">- KeyboardPress: &#123; type: &quot;KeyboardPress&quot;, param: &#123; value: string &#125; &#125;</span><br><span class="line">- Scroll: &#123; type: &quot;Scroll&quot;, locate: &#123;bbox: [number, number, number, number], prompt: string &#125; | null, param: &#123; direction: \&#x27;down\&#x27;(default) | \&#x27;up\&#x27; | \&#x27;right\&#x27; | \&#x27;left\&#x27;, scrollType: \&#x27;once\&#x27; (default) | \&#x27;untilBottom\&#x27; | \&#x27;untilTop\&#x27; | \&#x27;untilRight\&#x27; | \&#x27;untilLeft\&#x27;, distance: null | number &#125;&#125; // locate is the element to scroll. If it\&#x27;s a page scroll, put `null` in the `locate` field.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Field description:</span><br><span class="line">* The `prompt` field inside the `locate` field is a short description that could be used to locate the element.</span><br><span class="line"></span><br><span class="line">Return in JSON format:</span><br><span class="line">&#123;</span><br><span class="line">  &quot;what_the_user_wants_to_do_next_by_instruction&quot;: string, // What the user wants to do according to the instruction and previous logs. </span><br><span class="line">  &quot;log&quot;: string, // Log what the next one action (ONLY ONE!) you can do according to the screenshot and the instruction. The typical log looks like &quot;Now i want to use action \&#x27;&#123;&#123; action-type &#125;&#125;\&#x27; to do .. first&quot;. If no action should be done, log the reason. &quot;. Use the same language as the user\&#x27;s instruction.</span><br><span class="line">  &quot;error&quot;?: string, // Error messages about unexpected situations, if any. Only think it is an error when the situation is not expected according to the instruction. Use the same language as the user\&#x27;s instruction.</span><br><span class="line">  &quot;more_actions_needed_by_instruction&quot;: boolean, // Consider if there is still more action(s) to do after the action in &quot;Log&quot; is done, according to the instruction. If so, set this field to true. Otherwise, set it to false.</span><br><span class="line">  &quot;action&quot;: </span><br><span class="line">    &#123;</span><br><span class="line">      // one of the supporting actions</span><br><span class="line">    &#125; | null,</span><br><span class="line">  ,</span><br><span class="line">  &quot;sleep&quot;?: number, // The sleep time after the action, in milliseconds.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">For example, when the instruction is &quot;click \&#x27;Confirm\&#x27; button, and click \&#x27;Yes\&#x27; in popup&quot; and the log is &quot;I will use action Tap to click \&#x27;Confirm\&#x27; button&quot;, by viewing the screenshot and previous logs, you should consider: We have already clicked the \&#x27;Confirm\&#x27; button, so next we should find and click \&#x27;Yes\&#x27; in popup.</span><br><span class="line"></span><br><span class="line">this and output the JSON:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;what_the_user_wants_to_do_next_by_instruction&quot;: &quot;We have already clicked the \&#x27;Confirm\&#x27; button, so next we should find and click \&#x27;Yes\&#x27; in popup&quot;,</span><br><span class="line">  &quot;log&quot;: &quot;I will use action Tap to click \&#x27;Yes\&#x27; in popup&quot;,</span><br><span class="line">  &quot;more_actions_needed_by_instruction&quot;: false,</span><br><span class="line">  &quot;action&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;Tap&quot;,</span><br><span class="line">    &quot;locate&quot;: &#123;</span><br><span class="line">      &quot;bbox&quot;: [100, 100, 200, 200],</span><br><span class="line">      &quot;prompt&quot;: &quot;The \&#x27;Yes\&#x27; button in popup&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="User-prompt"><a href="#User-prompt" class="headerlink" title="User prompt"></a>User prompt</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`Here is the user&#x27;s instruction:&lt;instruction&gt;  &lt;high_priority_knowledge&gt;    undefined  &lt;/high_priority_knowledge&gt;  在搜索框输入 &quot;耳机&quot; ，敲回车&lt;/instruction&gt;`</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/05/02/astro-architecture-principles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/02/astro-architecture-principles/" class="post-title-link" itemprop="url">Astro Island架构实现原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-02 09:54:20" itemprop="dateCreated datePublished" datetime="2025-05-02T09:54:20+08:00">2025-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 10:06:48" itemprop="dateModified" datetime="2025-08-19T10:06:48+08:00">2025-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="什么是Islands架构"><a href="#什么是Islands架构" class="headerlink" title="什么是Islands架构"></a>什么是Islands架构</h2><p>Islands架构类似于微前端架构，但Islands主要是为了优化页面性能和用户体验，而微前端是为了解耦不同业务模块。</p>
<div align=right><img src="/images/island/arch.png" alt="island" width="500"/></div>

<h2 id="为什么要使用Islands"><a href="#为什么要使用Islands" class="headerlink" title="为什么要使用Islands"></a>为什么要使用Islands</h2><ol>
<li>可以优先展示或者水合重要内容，比如电商商品详情页可以优先展示和水合商品主图、商品描述、购买按钮。</li>
<li>浏览器加载的js变少，能够提升TTI。</li>
</ol>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="Astro有很多指令表示一个组件是在服务端渲染还是客户端渲染、渲染时机。"><a href="#Astro有很多指令表示一个组件是在服务端渲染还是客户端渲染、渲染时机。" class="headerlink" title="Astro有很多指令表示一个组件是在服务端渲染还是客户端渲染、渲染时机。"></a>Astro有很多<a target="_blank" rel="noopener" href="https://docs.astro.build/zh-cn/reference/directives-reference/#clientloadhttps://docs.astro.build/zh-cn/reference/directives-reference/#clientload">指令</a>表示一个组件是在服务端渲染还是客户端渲染、渲染时机。</h3><table>
<thead>
<tr>
<th>directives</th>
<th>description</th>
<th>priority</th>
</tr>
</thead>
<tbody><tr>
<td>client:load</td>
<td>页面加载后立即水合</td>
<td>high</td>
</tr>
<tr>
<td>client:idle</td>
<td>在requestIdleCallback中进行水合</td>
<td>medium</td>
</tr>
<tr>
<td>timeout</td>
<td>最大等待时间后水合</td>
<td>low</td>
</tr>
<tr>
<td>client:visible</td>
<td>进入视口后水合</td>
<td>low</td>
</tr>
<tr>
<td>client:media</td>
<td>媒体查询后水合</td>
<td>low</td>
</tr>
<tr>
<td>client:only</td>
<td>不进行服务端渲染</td>
<td>low</td>
</tr>
<tr>
<td>server:defer</td>
<td>按需渲染</td>
<td></td>
</tr>
</tbody></table>
<p>可以使用这个<a target="_blank" rel="noopener" href="https://github.com/withastro/astro/tree/dde8fd96cd6a7821b95f47ede7e30c36dad244d9/examples/with-nanostores">astro的模版</a>快速搭建一个demo</p>
<h2 id="使用client-load标记组件为Island组件，并且高优先级水合"><a href="#使用client-load标记组件为Island组件，并且高优先级水合" class="headerlink" title="使用client:load标记组件为Island组件，并且高优先级水合"></a>使用client:load标记组件为Island组件，并且高优先级水合</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">BuyNowButton</span> <span class="attr">client</span>:load onClick=&#123;handleClick&#125;&gt;点击购买&lt;/<span class="title class_">BuyNowButton</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>通过Astro的<a target="_blank" rel="noopener" href="https://github.com/withastro/compiler">compiler</a>将astro代码编译成如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; render <span class="keyword">as</span> $$render, createAstro <span class="keyword">as</span> $$createAstro, createComponent <span class="keyword">as</span> $$createComponent, renderComponent <span class="keyword">as</span> $$renderComponent &#125; <span class="keyword">from</span> <span class="string">&quot;astro/compiler-runtime&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BuyNowButton</span> <span class="keyword">from</span> <span class="string">&quot;../components/BuyNowButton&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; withBase &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> $$Astro = $$createAstro();</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Astro</span> = $$Astro;</span><br><span class="line"><span class="keyword">const</span> $$Index = $$createComponent(<span class="function">(<span class="params">$$result, $$props, $$slots</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Astro2</span> = $$result.<span class="title function_">createAstro</span>($$Astro, $$props, $$slots);</span><br><span class="line">    <span class="title class_">Astro2</span>.<span class="property">self</span> = $$Index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $$render<span class="string">`<span class="subst">$&#123;$$renderComponent($$result, <span class="string">&quot;BuyNowButton&quot;</span>, BuyNowButton, &#123; </span></span></span><br><span class="line"><span class="subst"><span class="string">        <span class="string">&quot;client:load&quot;</span>: <span class="literal">true</span>, </span></span></span><br><span class="line"><span class="subst"><span class="string">        <span class="string">&quot;client:component-hydration&quot;</span>: <span class="string">&quot;load&quot;</span>, </span></span></span><br><span class="line"><span class="subst"><span class="string">        <span class="string">&quot;client:component-path&quot;</span>: <span class="string">&quot;/with-nanostores/src/components/BuyNowButton&quot;</span>, </span></span></span><br><span class="line"><span class="subst"><span class="string">        <span class="string">&quot;client:component-export&quot;</span>: <span class="string">&quot;default&quot;</span>, </span></span></span><br><span class="line"><span class="subst"><span class="string">        <span class="string">&quot;data-astro-cid-j7pv25f6&quot;</span>: <span class="literal">true</span> </span></span></span><br><span class="line"><span class="subst"><span class="string">    &#125;)&#125;</span>`</span>;</span><br><span class="line">&#125;, <span class="string">&quot;/with-nanostores/src/pages/index.astro&quot;</span>, <span class="keyword">void</span> <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>在renderComponent中会将标记为client:load的组件渲染成</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">astro-island</span> <span class="attr">uid</span>=<span class="string">&quot;Z1xkbrp&quot;</span> <span class="attr">component-url</span>=<span class="string">&quot;/src/components/BuyNowButton.tsx&quot;</span> <span class="attr">component-export</span>=<span class="string">&quot;default&quot;</span> <span class="attr">renderer-url</span>=<span class="string">&quot;/node_modules/.vite/deps/@astrojs_preact_client-dev__js.js?v=ec7158f6&quot;</span> <span class="attr">props</span>=<span class="string">&quot;&#123;<span class="symbol">&amp;quot;</span>data-astro-cid-sckkx6r4<span class="symbol">&amp;quot;</span>:[0,true]&#125;&quot;</span> <span class="attr">client</span>=<span class="string">&quot;load&quot;</span> <span class="attr">before-hydration-url</span>=<span class="string">&quot;/@id/astro:scripts/before-hydration.js&quot;</span> <span class="attr">opts</span>=<span class="string">&quot;&#123;<span class="symbol">&amp;quot;</span>name<span class="symbol">&amp;quot;</span>:<span class="symbol">&amp;quot;</span>BuyNowButton<span class="symbol">&amp;quot;</span>,<span class="symbol">&amp;quot;</span>value<span class="symbol">&amp;quot;</span>:true&#125;&quot;</span> <span class="attr">server-render-time</span>=<span class="string">&quot;1.461416999999983&quot;</span> <span class="attr">await-children</span>=<span class="string">&quot;&quot;</span> <span class="attr">client-render-time</span>=<span class="string">&quot;1&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">aside</span> <span class="attr">hidden</span>=<span class="string">&quot;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;_container_jwp5b_1&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Your cart is empty!<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">aside</span>&gt;</span><span class="tag">&lt;/<span class="name">astro-island</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>服务端返回的就是上面的html，并且会返回astro-island.js文件，该文件注册astro-island自定义元素，<br>该元素在connectCallback后获取astro dom上的component-url、renderer-url（hydrator水合器）和props。最后await hydrator(&lt;Component {…props}&#x2F;&gt;)渲染组件</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://jasonformat.com/islands-architecture/">https://jasonformat.com/islands-architecture/</a><br><a target="_blank" rel="noopener" href="https://docs.astro.build/zh-cn/concepts/why-astro/#_top">https://docs.astro.build/zh-cn/concepts/why-astro/#_top</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jlg1128.github.io/2025/04/14/react-state-manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator-2.jpeg">
      <meta itemprop="name" content="Jlg1128">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JLG's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | JLG's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/14/react-state-manager/" class="post-title-link" itemprop="url">React状态管理库对比</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-14 10:06:47" itemprop="dateCreated datePublished" datetime="2025-04-14T10:06:47+08:00">2025-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 10:09:41" itemprop="dateModified" datetime="2025-08-19T10:09:41+08:00">2025-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>对比React常见的状态管理库context、Redux、MobX、zustand、jotai以及介绍它们的使用场景</p>
<h2 id="context"><a href="#context" class="headerlink" title="context"></a>context</h2><p>context被创造出来就是为了解决<a target="_blank" rel="noopener" href="https://react.dev/learn/passing-data-deeply-with-context">prop drilling</a>的问题，但是它存在重复渲染的问题，可以用<a href="use-context-selector">https://github.com/dai-shi/use-context-selector</a>解决这个问题，也可以不依赖任何库去解决<a target="_blank" rel="noopener" href="https://github.com/dai-shi/use-context-selector/issues/109#issuecomment-1785147682">use-context-selector</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title function_">createContext</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Main</span> = (<span class="params">&#123; children &#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;useState(</span>&#x27;<span class="attr">light</span>&#x27;)&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> theme = <span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Redux-React-Redux"><a href="#Redux-React-Redux" class="headerlink" title="Redux + React-Redux"></a>Redux + React-Redux</h2><p>相对于context，redux是基于单向数据流，遵循不可变数据的原则性能较好易于调试、易于扩展、<a target="_blank" rel="noopener" href="https://redux.js.org/understanding/history-and-design/middleware">middleware支持</a>、生态较好，开发调试devtool比较方便，但是上手成本高，需要理解单向数据流的概念。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> counterSlice = <span class="title function_">createSlice</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;counter&#x27;</span>,</span><br><span class="line">  <span class="attr">initialState</span>: &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="attr">increment</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">value</span> += <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">decrement</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">value</span> -= <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">incrementByAmount</span>: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">value</span> += action.<span class="property">payload</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">configureStore</span>(&#123;</span><br><span class="line">  <span class="attr">reducer</span>: &#123;</span><br><span class="line">    <span class="attr">counter</span>: counterSlice.<span class="property">reducer</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> count = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">counter</span>.<span class="property">value</span>)</span><br><span class="line">  <span class="keyword">const</span> dispatch = <span class="title function_">useDispatch</span>()</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">aria-label</span>=<span class="string">&quot;Increment value&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(increment())&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          Increment</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">aria-label</span>=<span class="string">&quot;Decrement value&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(decrement())&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          Decrement</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zustand"><a href="#zustand" class="headerlink" title="zustand"></a>zustand</h2><p>相对于Redux有什么优势，参考<a target="_blank" rel="noopener" href="https://github.com/pmndrs/zustand/tree/main?tab=readme-ov-file#why-zustand-over-redux">官方</a>。</p>
<ol>
<li>zustand概念和使用上简单</li>
<li>Redux要使用Provider</li>
<li>zustand可以transient updates，就是组件能监听状态变更并且不造成重复渲染。<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useBearStore = <span class="title function_">create</span>(<span class="function">(<span class="params">set</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">bears</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">increasePopulation</span>: <span class="function">() =&gt;</span> <span class="title function_">set</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> (&#123; <span class="attr">bears</span>: state.<span class="property">bears</span> + <span class="number">1</span> &#125;)),</span><br><span class="line">  <span class="attr">removeAllBears</span>: <span class="function">() =&gt;</span> <span class="title function_">set</span>(&#123; <span class="attr">bears</span>: <span class="number">0</span> &#125;),</span><br><span class="line">&#125;))</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">BearCounter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> bears = <span class="title function_">useBearStore</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">bears</span>)</span><br><span class="line">  <span class="keyword">const</span> increasePopulation = <span class="title function_">useBearStore</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">increasePopulation</span>)</span><br><span class="line">  <span class="keyword">return</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;bears&#125; around here ...<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;increasePopulation&#125;</span>&gt;</span>one up<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="MobX"><a href="#MobX" class="headerlink" title="MobX"></a>MobX</h2><p>MobX通过透明的函数响应式编程使得状态管理变得简单和可扩展。MobX背后的哲学很简单: 任何源自应用状态的东西都应该自动地获得，其中包括UI、数据序列化等等，核心重点就是: MobX通过响应式编程实现简单高效，可扩展的状态管理。</p>
<p>相对于react-redux，MobX的优势主要在开发简单，不用太多样板代码，但是因为状态可以在多处修改导致追踪状态比较麻烦，并且MobX不需要selector就能避免re-reneder，设置值的方式也不需要像Zustand那样必须要set(state &#x3D;&gt; newState)，更符合直觉，体验更好</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Timer</span> &#123;</span><br><span class="line">    secondsPassed = <span class="number">0</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">makeAutoObservable</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">increaseTimer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">secondsPassed</span> += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> myTimer = <span class="keyword">new</span> <span class="title class_">Timer</span>()</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">TimerView</span> = <span class="title function_">observer</span>(<span class="function">(<span class="params">&#123; timer &#125;</span>) =&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>Seconds passed: &#123;timer.secondsPassed&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>)</span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">TimerView</span> <span class="attr">timer</span>=<span class="string">&#123;myTimer&#125;</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="property">body</span>)</span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    myTimer.<span class="title function_">increaseTimer</span>()</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<h2 id="jotai"><a href="#jotai" class="headerlink" title="jotai"></a>jotai</h2><p>jotai上手简单，生态较完善，并且DX比较不错，使用不需要层层传递props，而且不像Context会重复渲染，缺点在复杂应用中状态太多不好管理，需要在上层封装Model、Controller层。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; atom, useAtom &#125; <span class="keyword">from</span> <span class="string">&#x27;jotai&#x27;</span></span><br><span class="line"><span class="comment">// 定义原子状态</span></span><br><span class="line"><span class="keyword">const</span> userIdAtom = <span class="title function_">atom</span>(<span class="number">1</span>)</span><br><span class="line"><span class="comment">// 派生状态</span></span><br><span class="line"><span class="keyword">const</span> userAtom = <span class="title function_">atom</span>(<span class="title function_">async</span> (get, &#123; signal &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = <span class="title function_">get</span>(userIdAtom)</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(</span><br><span class="line">    <span class="string">`https://jsonplaceholder.typicode.com/users/<span class="subst">$&#123;userId&#125;</span>?_delay=2000`</span>,</span><br><span class="line">    &#123; signal &#125;,</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">return</span> response.<span class="title function_">json</span>()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Controls</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 使用atom</span></span><br><span class="line">  <span class="keyword">const</span> [userId, setUserId] = <span class="title function_">useAtom</span>(userIdAtom)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      User Id: &#123;userId&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setUserId((c) =&gt; c - 1)&#125;&gt;Prev<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setUserId((c) =&gt; c + 1)&#125;&gt;Next<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">UserName</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [user] = <span class="title function_">useAtom</span>(userAtom)</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>User name: &#123;user.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="valtio"><a href="#valtio" class="headerlink" title="valtio"></a>valtio</h2><p>updating…</p>
<h2 id="何时使用"><a href="#何时使用" class="headerlink" title="何时使用"></a>何时使用</h2><h3 id="Context-reducer"><a href="#Context-reducer" class="headerlink" title="Context + reducer"></a>Context + reducer</h3><p>不想依赖第三方库，项目比较简单</p>
<h3 id="MobX-1"><a href="#MobX-1" class="headerlink" title="MobX"></a>MobX</h3><p>快速开发和快速PMF，中大型项目也可以</p>
<h3 id="zustand-1"><a href="#zustand-1" class="headerlink" title="zustand"></a>zustand</h3><p>快速开发和快速PMF，中大型项目也可以，需要undo&#x2F;redo</p>
<h3 id="React-Redux"><a href="#React-Redux" class="headerlink" title="React-Redux"></a>React-Redux</h3><p>项目复杂，需要长期维护，undo&#x2F;redo</p>
<h3 id="jotai-1"><a href="#jotai-1" class="headerlink" title="jotai"></a>jotai</h3><p>中小型项目</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://medium.com/@brechtcorbeel/understanding-the-core-principles-of-react-a-comprehensive-introduction-cb56f0435ea1">https://medium.com/@brechtcorbeel/understanding-the-core-principles-of-react-a-comprehensive-introduction-cb56f0435ea1</a><br><a target="_blank" rel="noopener" href="https://medium.com/@padmagnanapriya/state-management-in-react-comparing-context-api-redux-0403748a241f">https://medium.com/@padmagnanapriya/state-management-in-react-comparing-context-api-redux-0403748a241f</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6973977847547297800?searchId=20250421092546DCBB5357F0DDC339B843#heading-11">https://juejin.cn/post/6973977847547297800?searchId=20250421092546DCBB5357F0DDC339B843#heading-11</a><br><a target="_blank" rel="noopener" href="https://cn.redux.js.org/faq/immutable-data/#what-are-the-benefits-of-immutability">https://cn.redux.js.org/faq/immutable-data/#what-are-the-benefits-of-immutability</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Jlg1128</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"Jlg1128/Jlg1128.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkzMTcxNTI0NzQ=","category":"Announcements","category_id":"DIC_kwDOEudc2s4CtyRZ","mapping":"pathname","strict":0,"reactions_enabled":1,"emit_metadata":0,"theme":"preferred_color_scheme","lang":"en","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-strict'           : CONFIG.giscus.strict,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
